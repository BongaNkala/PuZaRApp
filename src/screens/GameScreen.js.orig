import React, { useState, useEffect } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  FlatList, 
  TouchableOpacity, 
  Alert,
  Modal,
  TextInput,
  Button
} from 'react-native';
import gameCards from '../data/gameCards';

const GameScreen = ({ route, navigation }) => {
  const selectedMode = route?.params?.mode || 'THE WARM UP';
  const level = route?.params?.level || 'Beginner';
  const players = route?.params?.players || ['Player 1', 'Player 2'];
  
  const [modeGames, setModeGames] = useState([]);
  const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
  const [showAnswerModal, setShowAnswerModal] = useState(false);
  const [currentCard, setCurrentCard] = useState(null);
  const [userAnswer, setUserAnswer] = useState('');
  const [scores, setScores] = useState({});
  const [usedCards, setUsedCards] = useState([]);
  const [timer, setTimer] = useState(30);
  
  // Initialize
  useEffect(() => {
    const games = gameCards.getCardsByMode(selectedMode);
    setModeGames(games);
    
    // Initialize scores
    const initialScores = {};
    players.forEach(player => {
      initialScores[player] = 0;
    });
    setScores(initialScores);
    
    console.log(`ÌΩª Starting ${selectedMode} drinking game!`);
    console.log(`Ì±• Players: ${players.join(', ')}`);
    console.log(`ÌæØ Difficulty: ${level}`);
  }, []);
  
  // Timer effect
  useEffect(() => {
    if (timer > 0 && currentCard) {
      const interval = setInterval(() => {
        setTimer(prev => prev - 1);
      }, 1000);
      return () => clearInterval(interval);
    } else if (timer === 0 && currentCard) {
      handleTimeUp();
    }
  }, [timer, currentCard]);
  
  const startNewCard = () => {
    // Get unused cards
    const unusedCards = modeGames.filter(card => !usedCards.includes(card.id));
    
    if (unusedCards.length === 0) {
      Alert.alert(
        'Game Over! ÌøÜ',
        `All cards played!\n\nFinal Scores:\n${Object.entries(scores).map(([player, score]) => `${player}: ${score}`).join('\n')}`,
        [{ text: 'Back to Modes', onPress: () => navigation.goBack() }]
      );
      return;
    }
    
    // Pick random card
    const randomCard = unusedCards[Math.floor(Math.random() * unusedCards.length)];
    setCurrentCard(randomCard);
    setUsedCards(prev => [...prev, randomCard.id]);
    setTimer(30);
    setUserAnswer('');
    setShowAnswerModal(true);
  };
  
  const handleTimeUp = () => {
    Alert.alert(
      'Time\'s Up! ‚è∞',
      `You took too long!\n\n${currentPlayer} drinks ${currentCard.penaltyShots} shot${currentCard.penaltyShots > 1 ? 's' : ''}!`,
      [{ text: 'Next Player', onPress: nextPlayer }]
    );
  };
  
  const checkAnswer = () => {
    const correct = userAnswer.trim().toLowerCase() === currentCard.answer.toLowerCase();
    
    if (correct) {
      // Player gets points
      const newScores = { ...scores };
      newScores[currentPlayer] += 100;
      setScores(newScores);
      
      Alert.alert(
        'Correct! Ìæâ',
        `${currentPlayer} avoids drinking!\n+100 points`,
        [{ text: 'Next Player', onPress: nextPlayer }]
      );
    } else {
      // Player drinks
      Alert.alert(
        'Wrong! ÌΩ∫',
        `${currentPlayer} drinks ${currentCard.penaltyShots} shot${currentCard.penaltyShots > 1 ? 's' : ''}!\n\nCorrect answer: ${currentCard.answer}`,
        [{ text: 'Drink Up!', onPress: nextPlayer }]
      );
    }
    
    setShowAnswerModal(false);
  };
  
  const nextPlayer = () => {
    setCurrentPlayerIndex((currentPlayerIndex + 1) % players.length);
    startNewCard();
  };
  
  const currentPlayer = players[currentPlayerIndex];
  const drinkingRules = gameCards.getModeDrinkingRules(selectedMode);
  
  const renderCard = ({ item, index }) => (
    <TouchableOpacity 
      style={[
        styles.card, 
        { borderLeftColor: getDifficultyColor(item.difficulty) },
        usedCards.includes(item.id) && styles.usedCard
      ]}
      onPress={() => {
        setCurrentCard(item);
        setShowAnswerModal(true);
      }}
      disabled={usedCards.includes(item.id)}
    >
      <Text style={styles.cardText}>{item.text}</Text>
      <View style={styles.cardTags}>
        <Text style={styles.tag}>{item.type.toUpperCase()}</Text>
        <Text style={[styles.tag, styles.difficultyTag]}>
          {item.difficulty.toUpperCase()}
        </Text>
        <Text style={[styles.tag, styles.shotTag]}>
          ÌΩ∫ {item.penaltyShots}
        </Text>
      </View>
      {usedCards.includes(item.id) && (
        <Text style={styles.usedText}>PLAYED</Text>
      )}
    </TouchableOpacity>
  );
  
  const getDifficultyColor = (difficulty) => {
    switch(difficulty) {
      case 'easy': return '#4CAF50'; // Green
      case 'medium': return '#FF9800'; // Orange
      case 'hard': return '#F44336'; // Red
      default: return '#9E9E9E';
    }
  };
  
  return (
    <View style={styles.container}>
      {/* Header */}
      <View style={[styles.header, { backgroundColor: getHeaderColor(selectedMode) }]}>
        <Text style={styles.title}>{selectedMode}</Text>
        <Text style={styles.subtitle}>{level} ‚Ä¢ {modeGames.length} Challenges</Text>
        <Text style={styles.drinkingStats}>
          Penalty: {drinkingRules.minShots}-{drinkingRules.maxShots} shots per fail
        </Text>
      </View>
      
      {/* Game Info Bar */}
      <View style={styles.gameInfo}>
        <View style={styles.playerTurn}>
          <Text style={styles.turnLabel}>NOW PLAYING:</Text>
          <Text style={styles.currentPlayer}>{currentPlayer}</Text>
        </View>
        
        <TouchableOpacity style={styles.startButton} onPress={startNewCard}>
          <Text style={styles.startButtonText}>START CARD ‚ñ∂</Text>
        </TouchableOpacity>
      </View>
      
      {/* Scores */}
      <View style={styles.scoreBoard}>
        <Text style={styles.scoreTitle}>SCORES</Text>
        <View style={styles.scoreList}>
          {players.map((player, index) => (
            <View key={player} style={[
              styles.scoreItem,
              index === currentPlayerIndex && styles.activeScoreItem
            ]}>
              <Text style={styles.playerName}>{player}</Text>
              <Text style={styles.playerScore}>{scores[player] || 0}</Text>
            </View>
          ))}
        </View>
      </View>
      
      {/* Cards List */}
      <View style={styles.cardsSection}>
        <Text style={styles.sectionTitle}>CHALLENGES ({modeGames.length})</Text>
        <FlatList
          data={modeGames}
          renderItem={renderCard}
          keyExtractor={item => item.id.toString()}
          contentContainerStyle={styles.cardsList}
          numColumns={2}
        />
      </View>
      
      {/* Answer Modal */}
      <Modal
        visible={showAnswerModal}
        animationType="slide"
        transparent={true}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            {currentCard && (
              <>
                <View style={styles.modalHeader}>
                  <Text style={styles.modalTitle}>CHALLENGE!</Text>
                  <Text style={styles.modalTimer}>‚è±Ô∏è {timer}s</Text>
                </View>
                
                <Text style={styles.modalQuestion}>{currentCard.text}</Text>
                <Text style={styles.modalPlayer}>Player: {currentPlayer}</Text>
                <Text style={styles.modalPenalty}>
                  Penalty: {currentCard.penaltyShots} shot{currentCard.penaltyShots > 1 ? 's' : ''} if wrong!
                </Text>
                
                <TextInput
                  style={styles.answerInput}
                  placeholder="Your answer..."
                  value={userAnswer}
                  onChangeText={setUserAnswer}
                  autoCapitalize="characters"
                />
                
                <View style={styles.modalButtons}>
                  <TouchableOpacity 
                    style={styles.submitButton}
                    onPress={checkAnswer}
                    disabled={!userAnswer.trim()}
                  >
                    <Text style={styles.submitButtonText}>SUBMIT ANSWER</Text>
                  </TouchableOpacity>
                  
                  <TouchableOpacity 
                    style={styles.skipButton}
                    onPress={() => {
                      setShowAnswerModal(false);
                      nextPlayer();
                    }}
                  >
                    <Text style={styles.skipButtonText}>SKIP (Drink {currentCard.penaltyShots})</Text>
                  </TouchableOpacity>
                </View>
              </>
            )}
          </View>
        </View>
      </Modal>
    </View>
  );
};

// Helper function for header color based on mode
const getHeaderColor = (mode) => {
  switch(mode) {
    case 'THE WARM UP': return '#F59E0B'; // Amber
    case 'BRAIN BURNER': return '#EF4444'; // Red
    case 'ULTIMATE CHALLENGE': return '#7C3AED'; // Purple
    default: return '#3B82F6'; // Blue
  }
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#0F172A',
  },
  header: {
    padding: 20,
    paddingTop: 50,
    borderBottomLeftRadius: 25,
    borderBottomRightRadius: 25,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 10,
  },
  title: {
    fontSize: 32,
    fontWeight: '900',
    color: 'white',
    textAlign: 'center',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 2, height: 2 },
    textShadowRadius: 4,
  },
  subtitle: {
    fontSize: 16,
    color: 'rgba(255,255,255,0.9)',
    textAlign: 'center',
    marginTop: 5,
    fontWeight: '600',
  },
  drinkingStats: {
    fontSize: 14,
    color: 'rgba(255,255,255,0.8)',
    textAlign: 'center',
    marginTop: 10,
    backgroundColor: 'rgba(0,0,0,0.2)',
    paddingHorizontal: 15,
    paddingVertical: 5,
    borderRadius: 20,
    alignSelf: 'center',
  },
  gameInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 15,
    backgroundColor: '#1E293B',
    marginHorizontal: 15,
    marginTop: 20,
    borderRadius: 15,
  },
  playerTurn: {
    flex: 1,
  },
  turnLabel: {
    fontSize: 12,
    color: '#94A3B8',
    fontWeight: '600',
  },
  currentPlayer: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#F59E0B',
  },
  startButton: {
    backgroundColor: '#10B981',
    paddingHorizontal: 20,
    paddingVertical: 12,
    borderRadius: 10,
    shadowColor: '#10B981',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.5,
    shadowRadius: 8,
    elevation: 5,
  },
  startButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 14,
  },
  scoreBoard: {
    backgroundColor: '#1E293B',
    marginHorizontal: 15,
    marginTop: 15,
    padding: 15,
    borderRadius: 15,
  },
  scoreTitle: {
    color: '#94A3B8',
    fontSize: 12,
    fontWeight: '600',
    marginBottom: 10,
  },
  scoreList: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 10,
  },
  scoreItem: {
    flex: 1,
    backgroundColor: '#334155',
    padding: 10,
    borderRadius: 10,
    minWidth: 100,
  },
  activeScoreItem: {
    backgroundColor: '#F59E0B',
  },
  playerName: {
    color: '#E2E8F0',
    fontSize: 14,
    fontWeight: '600',
  },
  playerScore: {
    color: '#F59E0B',
    fontSize: 24,
    fontWeight: 'bold',
    marginTop: 5,
  },
  cardsSection: {
    flex: 1,
    marginTop: 15,
    paddingHorizontal: 15,
  },
  sectionTitle: {
    color: '#94A3B8',
    fontSize: 14,
    fontWeight: '600',
    marginBottom: 10,
  },
  cardsList: {
    paddingBottom: 20,
  },
  card: {
    flex: 1,
    backgroundColor: '#1E293B',
    padding: 15,
    margin: 5,
    borderRadius: 12,
    borderLeftWidth: 5,
    minHeight: 120,
    justifyContent: 'space-between',
  },
  usedCard: {
    opacity: 0.6,
  },
  cardText: {
    color: '#E2E8F0',
    fontSize: 14,
    fontWeight: '600',
    flex: 1,
  },
  cardTags: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 5,
    marginTop: 10,
  },
  tag: {
    fontSize: 10,
    color: '#94A3B8',
    backgroundColor: '#334155',
    paddingHorizontal: 8,
    paddingVertical: 3,
    borderRadius: 10,
    fontWeight: '600',
  },
  difficultyTag: {
    backgroundColor: '#334155',
  },
  shotTag: {
    backgroundColor: '#7C2D12',
    color: '#FBBF24',
  },
  usedText: {
    position: 'absolute',
    top: 10,
    right: 10,
    color: '#EF4444',
    fontSize: 10,
    fontWeight: 'bold',
    transform: [{ rotate: '15deg' }],
  },
  // Modal styles
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.9)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    backgroundColor: '#1E293B',
    width: '90%',
    borderRadius: 20,
    padding: 25,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 10 },
    shadowOpacity: 0.5,
    shadowRadius: 20,
    elevation: 20,
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
  },
  modalTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#F59E0B',
  },
  modalTimer: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#EF4444',
  },
  modalQuestion: {
    fontSize: 20,
    fontWeight: '600',
    color: '#E2E8F0',
    marginBottom: 20,
    lineHeight: 28,
  },
  modalPlayer: {
    fontSize: 16,
    color: '#94A3B8',
    marginBottom: 5,
  },
  modalPenalty: {
    fontSize: 16,
    color: '#EF4444',
    fontWeight: 'bold',
    marginBottom: 20,
  },
  answerInput: {
    backgroundColor: '#334155',
    color: 'white',
    padding: 15,
    borderRadius: 10,
    fontSize: 18,
    marginBottom: 20,
  },
  modalButtons: {
    gap: 10,
  },
  submitButton: {
    backgroundColor: '#10B981',
    padding: 15,
    borderRadius: 10,
    alignItems: 'center',
  },
  submitButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 16,
  },
  skipButton: {
    backgroundColor: '#EF4444',
    padding: 15,
    borderRadius: 10,
    alignItems: 'center',
  },
  skipButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 14,
  },
});

export default GameScreen;
